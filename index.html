"use client";

import { useEffect, useState } from "react";

// ===== CONFIG =====
const GRID_SIZE = 11;
const CELL_SIZE = 28;
const START = { x: 0, y: 10 };
const GOAL = { x: 10, y: 0 };

// ===== MAZE =====
const MAZE = [
  [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0],
  [1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0],
  [1, 0, 1, 0, 1, 0, 1, 1, 0, 1, 0],
  [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
  [1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 1],
  [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
  [1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1],
  [1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1],
  [1, 0, 1, 1, 1, 1, 1, 0, 1, 0, 1],
  [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
  [0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1],
];

// ===== TRAPS =====
const TRAPS = [
  { x: 5, y: 9 },
  { x: 7, y: 3 },
  { x: 6, y: 4 },
  { x: 3, y: 1 },
];

export default function Page() {
  const [stage, setStage] = useState<"intro" | "maze" | "result">("intro");
  const [text, setText] = useState("");
  const [pos, setPos] = useState(START);
  const [startTime, setStartTime] = useState<number | null>(null);
  const [elapsed, setElapsed] = useState(0);
  const [trapCount, setTrapCount] = useState(0);
  const [revealedTraps, setRevealedTraps] = useState<string[]>([]);

  const narration =
    "íƒœì´ˆì˜ ë±€íŒŒì´ì–´ë¥¼ ë°©ë¬¸í•˜ê²Œ ëœ ë‹¹ì‹ .\n" +
    "í•˜ì§€ë§Œ ì €íƒì€ ìƒê°ë³´ë‹¤ ì™¸ì§„ ê³³ì— ìˆëŠ”ë°â€¦\n" +
    "ê³¼ì—° ì‹œê°„ ë‚´ì— ê¸¸ì„ ì°¾ì•„ê°ˆ ìˆ˜ ìˆì„ê¹Œ?";

  // ===== íƒ€ì´í•‘ íš¨ê³¼ =====
  useEffect(() => {
    if (stage !== "intro") return;
    let i = 0;
    const timer = setInterval(() => {
      setText(narration.slice(0, i + 1));
      i++;
      if (i >= narration.length) clearInterval(timer);
    }, 40);
    return () => clearInterval(timer);
  }, [stage]);

  // ===== íƒ€ì´ë¨¸ =====
  useEffect(() => {
    if (!startTime || stage !== "maze") return;
    const t = setInterval(() => {
      setElapsed(Math.floor((Date.now() - startTime) / 1000));
    }, 1000);
    return () => clearInterval(t);
  }, [startTime, stage]);

  // ===== í‚¤ë³´ë“œ ì´ë™ =====
  useEffect(() => {
    if (stage !== "maze") return;
    const onKey = (e: KeyboardEvent) => {
      if (e.key === "ArrowUp") move(0, -1);
      if (e.key === "ArrowDown") move(0, 1);
      if (e.key === "ArrowLeft") move(-1, 0);
      if (e.key === "ArrowRight") move(1, 0);
    };
    window.addEventListener("keydown", onKey);
    return () => window.removeEventListener("keydown", onKey);
  });

  const move = (dx: number, dy: number) => {
    const nx = pos.x + dx;
    const ny = pos.y + dy;
    if (nx < 0 || ny < 0 || nx >= GRID_SIZE || ny >= GRID_SIZE) return;
    if (MAZE[ny][nx] === 1) return;

    const trap = TRAPS.find((t) => t.x === nx && t.y === ny);
    if (trap) {
      const key = `${nx},${ny}`;
      setPos({ x: nx, y: ny });
      if (!revealedTraps.includes(key)) {
        setTrapCount((c) => c + 1);
        setRevealedTraps((r) => [...r, key]);
      }
      setTimeout(() => {
        setPos(START);
        setRevealedTraps([]);
      }, 400);
      return;
    }

    setPos({ x: nx, y: ny });
    if (nx === GOAL.x && ny === GOAL.y) setStage("result");
  };

  // ===== INTRO =====
  if (stage === "intro") {
    return (
      <div style={screenStyle}>
        <p style={introTextStyle}>{text}</p>
        {text.length === narration.length && (
          <button
            onClick={() => {
              setStage("maze");
              setStartTime(Date.now());
            }}
            style={mainButton}
          >
            ì €íƒìœ¼ë¡œ ê°€ê¸°
          </button>
        )}
      </div>
    );
  }

  // ===== MAZE =====
  if (stage === "maze") {
    return (
      <div style={screenStyle}>
        <div
          style={{
            display: "grid",
            gridTemplateColumns: `repeat(${GRID_SIZE}, ${CELL_SIZE}px)`,
            gap: 2,
          }}
        >
          {MAZE.flatMap((row, y) =>
            row.map((cell, x) => {
              const isPlayer = pos.x === x && pos.y === y;
              const isGoal = GOAL.x === x && GOAL.y === y;
              const revealed = revealedTraps.includes(`${x},${y}`);
              return (
                <div
                  key={`${x}-${y}`}
                  style={{
                    width: CELL_SIZE,
                    height: CELL_SIZE,
                    background: cell === 1 ? "#2a0006" : "#111",
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "center",
                    fontSize: 18,
                  }}
                >
                  {isPlayer && "ğŸ‘§"}
                  {isGoal && "ğŸ°"}
                  {revealed && "ğŸ§›â€â™€ï¸"}
                </div>
              );
            })
          )}
        </div>

        {/* ğŸ”½ ì‘ì•„ì§„ í™”ì‚´í‘œ UI */}
        <div style={{ marginTop: 14, lineHeight: 1.2 }}>
          <button style={controlBtn} onClick={() => move(0, -1)}>â–²</button><br />
          <button style={controlBtn} onClick={() => move(-1, 0)}>â—€</button>
          <button style={controlBtn} onClick={() => move(1, 0)}>â–¶</button><br />
          <button style={controlBtn} onClick={() => move(0, 1)}>â–¼</button>
        </div>
      </div>
    );
  }

  // ===== RESULT =====
  return (
    <div style={screenStyle}>
      <h1 style={{ fontSize: 24, marginBottom: 12 }}>ì €íƒì— ë„ì°©í•˜ì…¨ìŠµë‹ˆë‹¤</h1>

      <p style={resultLine}>
        ì†Œìš” ì‹œê°„<br /><strong>{elapsed}ì´ˆ</strong>
      </p>

      <p style={resultLine}>
        í•¨ì •ì— ê±¸ë¦° íšŸìˆ˜<br /><strong>{trapCount}íšŒ</strong>
      </p>

      <p style={{ marginTop: 26, lineHeight: 1.6 }}>
        ë¬´ì‚¬íˆ ë±€íŒŒì´ì–´ì˜ ì €íƒì—<br />
        ë„ì°©í•œ ë‹¹ì‹ .
      </p>

      <p style={{ marginTop: 14 }}>
        ê·¸ ì´í›„ì˜ ì´ì•¼ê¸°ê°€ ê¶ê¸ˆí•˜ë‹¤ë©´
      </p>

      <p style={{ marginTop: 8, lineHeight: 1.6 }}>
        ì—°ê·¹<br />
        <strong>&lt;ë±€íŒŒì´ì–´ë¥¼ ì´í•´í•˜ëŠ” íŠ¹ë³„í•œ ë°©ë²•&gt;</strong><br />
        ë§ì€ ê´€ì‹¬ ë¶€íƒë“œë¦½ë‹ˆë‹¤.
      </p>

      <a
        href="https://tickets.interpark.com/goods/26000875"
        target="_blank"
        style={mainButton}
      >
        í‹°ì¼“ ì˜¤í”ˆ ì‚¬ì´íŠ¸ ë°”ë¡œê°€ê¸°
      </a>
    </div>
  );
}

// ===== STYLES =====
const screenStyle = {
  minHeight: "100vh",
  background: "#000",
  color: "#fff",
  display: "flex",
  flexDirection: "column" as const,
  justifyContent: "center",
  alignItems: "center",
  padding: 24,
  textAlign: "center" as const,
};

const introTextStyle = {
  maxWidth: 360,
  fontSize: 18,
  lineHeight: 1.7,
  whiteSpace: "pre-line" as const,
  color: "#7a1f2b",
};

const mainButton = {
  marginTop: 24,
  padding: "12px 24px",
  background: "#7a1f2b",
  color: "#000",
  borderRadius: 12,
  fontWeight: 600,
};

const controlBtn = {
  width: 42,
  height: 36,
  margin: 4,
  background: "#7a1f2b",
  color: "#000",
  borderRadius: 10,
  fontSize: 12,
  fontWeight: 600,
};

const resultLine = {
  marginTop: 14,
  lineHeight: 1.6,
};

